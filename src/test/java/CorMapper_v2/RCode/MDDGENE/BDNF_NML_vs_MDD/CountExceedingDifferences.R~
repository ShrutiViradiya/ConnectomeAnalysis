
# 引数には　"network_mes_rslt.txt"　"VolMeanOfEachArea.txt"　を保持するフォルダを指定する。
# ex) Rscript CountExceedingDifferences.R ../wd_test/
# ex) Rscript CountExceedingDifferences.R ../wd_AD_vs_NML_deep/
# ex) Rscript CountExceedingDifferences.R ../wd_AD_vs_cMCI_deep/
# ex) Rscript CountExceedingDifferences.R ../wd_AD_vs_ncMCI_deep/
# ex) Rscript CountExceedingDifferences.R ../wd_cMCI_vs_NML_deep/
# ex) Rscript CountExceedingDifferences.R ../wd_cMCI_vs_ncMCI_deep/
# ex) Rscript CountExceedingDifferences.R ../wd_ncMCI_vs_NML_deep/
#
# Rscript ./CountExceedingDifferences.R ../wd_NMLMET_vs_NMLVAL_deep+surf/


#
# 解析対象の設定
#
OUTPUT_FOLDER_PATH <- commandArgs()[6]
INPUT_FOLDER_PATH <- commandArgs()[6]
file_set <- system(paste("ls ",INPUT_FOLDER_PATH,"*.txt",sep=""),intern=T)

for(TARGET_FILE_PATH in file_set){
#
# 出力先ファイルの初期化
#
#source("Variables.R")
OutputFileNeme <- basename(TARGET_FILE_PATH)
OutputFileNeme <- gsub("\\.[0-9A-Za-z]+$", "", OutputFileNeme) #拡張子を一旦除去
OutputFileNeme <- paste(OutputFileNeme, ".pvals", sep="")
OutputFilePath <-  paste(OUTPUT_FOLDER_PATH, "CountExceedingDifferencesRslt_", OutputFileNeme, sep="")
if(!file.exists(OUTPUT_FOLDER_PATH)) dir.create(OUTPUT_FOLDER_PATH)
if(file.exists(OutputFilePath)) file.remove(OutputFilePath)
file.create(OutputFilePath)
OutputFile <- file(OutputFilePath, "a")

#
# 読み取り準備
#
#TARGET_FILE_PATH <- paste(OUTPUT_FOLDER_PATH, TARGET_FILE_PATH, sep="")
df <- read.table(TARGET_FILE_PATH, header=T, sep=" ", stringsAsFactors=F)
#head(df)

cat("#######################################\n")
cat("###   Count Exceeding Differences   ###\n")
cat("#######################################\n")

names_of_col <- colnames(df)
for( c in 2:ncol(df)){

    cat("解析対象指標: ", names_of_col[c], "\n")
writeLines(paste("解析対象指標: ", names_of_col[c]), OutputFile)

#ObservedDiff <- as.numeric(as.matrix(df[1,c])) - as.numeric(as.matrix(df[2,c]))
value_of_ObservedGroupAGraph <- as.matrix(df[1,c])
value_of_ObservedGroupBGraph <- as.matrix(df[2,c])
ObservedDiff <- value_of_ObservedGroupAGraph - value_of_ObservedGroupBGraph
ObservedDiff
cat("    ObservedDiff:", ObservedDiff,"\n")
writeLines(paste("ObservedDiff: ", ObservedDiff, sep=""), OutputFile)

Simulated_diff_values <- c()
r <- 3
while(r < nrow(df)){
    cat("r=", r, "\n")
    diff <- as.numeric(as.matrix(df[r,c])) - as.numeric(as.matrix(df[r+1,c]))
    r <- r + 2
    Simulated_diff_values <- c(Simulated_diff_values, diff)
}
cat("    Simulated_diff_values: " , paste(Simulated_diff_values, collapse=" "), "\n")
writeLines(paste("Simulated_diff_values : ", paste(Simulated_diff_values, collapse=" ")), OutputFile)

#
# ★どう数えるか
#

exceeded_count_a <- sum(abs(ObservedDiff) > abs(Simulated_diff_values)) #絶対値
exceeded_count_b <- sum(abs(ObservedDiff) < abs(Simulated_diff_values)) #絶対値
exceeded_count_c <- sum(ObservedDiff > Simulated_diff_values) #非絶対値
exceeded_count_d <- sum(ObservedDiff < Simulated_diff_values) #非絶対値

iteration_count <- ((nrow(df)-2)/2)

p_value_a <- exceeded_count_a / iteration_count # 並べ替えp値。N回中何回観測値以上であったかを数える。
p_value_b <- exceeded_count_b / iteration_count # 並べ替えp値。N回中何回観測値以上であったかを数える。
p_value_c <- exceeded_count_c / iteration_count # 並べ替えp値。N回中何回観測値以上であったかを数える。
p_value_d <- exceeded_count_d / iteration_count # 並べ替えp値。N回中何回観測値以上であったかを数える。

cat("    |diff. of obs. value| > |diff. of sim. value| の回数：",iteration_count,"回中 ",exceeded_count_a,"回 (p値=", p_value_a,")\n")
writeLines(paste("|diff. of obs. value| > |diff. of sim. value| の回数：",iteration_count,"回中 ",exceeded_count_a, "回 (p値=", p_value_a, ")"), OutputFile)
cat("    |diff. of obs. value| < |diff. of sim. value| の回数：",iteration_count,"回中 ",exceeded_count_b,"回 (p値=", p_value_b,")\n")
writeLines(paste("|diff. of obs. value| < |diff. of sim. value| の回数：",iteration_count,"回中 ",exceeded_count_b, "回 (p値=", p_value_b, ")"), OutputFile)
cat("    diff. of obs. value > diff. of sim. value の回数：",iteration_count,"回中 ",exceeded_count_c,"回 (p値=", p_value_c,")\n")
writeLines(paste("diff. of obs. value > diff. of sim. value の回数：",iteration_count,"回中 ",exceeded_count_c, "回 (p値=", p_value_c, ")"), OutputFile)
cat("    diff. of obs. value  < diff. of sim. value の回数：",iteration_count,"回中 ",exceeded_count_d,"回 (p値=", p_value_d,")\n")
writeLines(paste("diff. of obs. value < diff. of sim. value の回数：",iteration_count,"回中 ",exceeded_count_d, "回 (p値=", p_value_d, ")"), OutputFile)

}
close(OutputFile)
}
